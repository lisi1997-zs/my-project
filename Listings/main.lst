C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\ARMMDK\mdkarm\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "reg52.h"
   2          #include "lcd1602.h"
   3          #include "ds1302.h"
   4          #include "common.h"
   5          
   6          // æŒ‰é”®å®šä¹‰
   7          sbit KEY_MODE  = P3^1;  // K1 - æ¨¡å¼åˆ‡æ¢/é€€å‡º
   8          sbit KEY_SEL   = P3^0;  // K2 - é€‰æ‹©ä½ç½®
   9          sbit KEY_UP    = P3^2;  // K3 - å¢åŠ 
  10          sbit KEY_DOWN  = P3^3;  // K4 - å‡å°‘
  11          sbit BEEP      = P2^0;
  12          
  13          u8 Time[7];
  14          u8 Temp_Time[7];
  15          u8 Alarm_Hour = 7;
  16          u8 Alarm_Min  = 0;
  17          u8 alarm_triggered = 0;
  18          u8 alarm_duration = 0;
  19          u8 alarm_enabled = 1; // 0: off, 1: on (persisted to DS1302 RAM 0)
  20          
  21          u8 mode = 0;           // 0:æ˜¾ç¤ºæ—¶é—´, 1:æ˜¾ç¤ºé—¹é’Ÿ, 2:è®¾ç½®é—¹é’Ÿ, 3:è®¾ç½®æ—¶é—´
  22          u8 set_time_index = 0; // æ—¶é—´è®¾ç½®é¡¹ç´¢å¼•
  23          u8 setting_mode = 0;   // 0:æ­£å¸¸, 1:è®¾ç½®ä¸­
  24          u8 alarm_edit_pos = 0; // 0:ç¼–è¾‘å°æ—¶, 1:ç¼–è¾‘åˆ†é’Ÿ
  25          u8 key_press_time = 0;
  26          u8 fast_mode = 0;
  27          // å¦‚æœ RTC æ•°æ®ä¸å¯ä¿¡ï¼Œå¼€æœºæ—¶ä¼šå¼ºåˆ¶è¿›å…¥è®¾ç½®æ¨¡å¼
  28          u8 rtc_invalid_start = 0;
  29          u8 suppress_lcd = 0; // å…¼å®¹æ—§é€»è¾‘ï¼ˆç°åœ¨ä¸å†é•¿æœŸæŠ‘åˆ¶ LCD æ›´æ–°ï¼‰
  30          // éé˜»å¡èœ‚é¸£æ§åˆ¶ï¼ˆé—¹é’Ÿå“é“ƒæœŸé—´ä½¿ç”¨ï¼‰
  31          u8 alarm_beep_active = 0;
  32          u8 alarm_beep_tick = 0;
  33          u8 alarm_lcd_tick = 0;
  34          u8 hour_mode = 0;      // 0: 24å°æ—¶åˆ¶, 1: 12å°æ—¶åˆ¶
  35          u8 hourly_chime = 0;   // 0: å…³é—­æ•´ç‚¹æŠ¥æ—¶, 1: å¼€å¯
  36          
  37          
  38          #define RAM_CHECK_ADDR  0x00  // å­˜æ”¾æ ¡éªŒæš—å·
  39          #define RAM_ALARM_H     0x01  // å­˜æ”¾é—¹é’Ÿæ—¶
  40          #define RAM_ALARM_M     0x02  // å­˜æ”¾é—¹é’Ÿåˆ†
  41          #define RAM_ALARM_EN    0x03  // å­˜æ”¾é—¹é’Ÿå¼€å…³
  42          #define RAM_HOUR_MODE   0x04
  43          #define RAM_HOURLY_EN   0x05
  44          // DelayMs åŸå‹ï¼ˆåœ¨æ–‡ä»¶é¡¶éƒ¨å£°æ˜ä»¥é¿å…åœ¨ä½¿ç”¨å‰ç¼–è¯‘å™¨æŠ¥é”™ï¼‰
  45          void DelayMs(u16 ms);
  46          
  47          // åœ¨é—¹é’Ÿé¦–æ¬¡è§¦å‘æ—¶ç”ŸæˆçŸ­ä¿ƒèœ‚é¸£è„‰å†²ï¼ˆé˜»å¡ï¼‰ï¼Œæé«˜è¢«åŠ¨/æœ‰æºèœ‚é¸£å™¨è§¦å‘æ¦‚ç‡
  48          void AlarmBeepBurst() {
  49   1          unsigned char i;
  50   1          // ç¡®ä¿ LCD è¢«æŠ‘åˆ¶
  51   1          suppress_lcd = 1;
  52   1          for(i = 0; i < 6; i++) {
  53   2              BEEP = 0;
  54   2              DelayMs(40);
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 2   

  55   2              BEEP = 1;
  56   2              DelayMs(40);
  57   2          }
  58   1      }
  59          
  60          // æ ¡éªŒä» RTC è¯»å–çš„ BCD æ—¶é—´æ˜¯å¦åœ¨åˆç†èŒƒå›´
  61          u8 BCD_to_Decimal(u8 bcd);
  62          u8 Decimal_to_BCD(u8 decimal);
  63          u8 IsTimeValid(unsigned char *t) {
  64   1          u8 sec = BCD_to_Decimal(t[0]);
  65   1          u8 min = BCD_to_Decimal(t[1]);
  66   1          u8 hour = BCD_to_Decimal(t[2]);
  67   1          u8 day = BCD_to_Decimal(t[3]);
  68   1          u8 month = BCD_to_Decimal(t[4]);
  69   1          u8 week = BCD_to_Decimal(t[5]);
  70   1          u8 year = BCD_to_Decimal(t[6]);
  71   1      
  72   1          if(sec > 59) return 0;
  73   1          if(min > 59) return 0;
  74   1          if(hour > 23) return 0;
  75   1          if(day < 1 || day > 31) return 0;
  76   1          if(month < 1 || month > 12) return 0;
  77   1          if(week < 1 || week > 7) return 0;
  78   1          if(year > 99) return 0;
  79   1          return 1;
  80   1      }
  81          
  82          // BCDè½¬åè¿›åˆ¶
  83          u8 BCD_to_Decimal(u8 bcd) {
  84   1          return ((bcd >> 4) * 10) + (bcd & 0x0F);
  85   1      }
  86          
  87          // åè¿›åˆ¶è½¬BCD
  88          u8 Decimal_to_BCD(u8 decimal) {
  89   1          return ((decimal / 10) << 4) | (decimal % 10);
  90   1      }
  91          
  92          void DelayMs(u16 ms) {
  93   1          u16 i, j;
  94   1          for(i = 0; i < ms; i++)
  95   1              for(j = 0; j < 120; j++);
  96   1      }
  97          
  98          // æŒ‰é”®æ£€æµ‹
  99          u8 KeyScan() {
 100   1          static u8 key_pressed = 0;
 101   1          u8 key = 0;
 102   1          
 103   1          if(KEY_MODE == 0) key = 1;
 104   1          else if(KEY_SEL == 0) key = 2;
 105   1          else if(KEY_UP == 0) key = 3;
 106   1          else if(KEY_DOWN == 0) key = 4;
 107   1          
 108   1          if(key != 0) {
 109   2              if(!key_pressed) {
 110   3                  key_pressed = 1;
 111   3                  key_press_time = 0;
 112   3                  fast_mode = 0;
 113   3                  return key;
 114   3              } else {
 115   3                  key_press_time++;
 116   3                  if(key_press_time > 30) {
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 3   

 117   4                      fast_mode = 1;
 118   4                      if((key_press_time % 5) == 0) {
 119   5                          return key;
 120   5                      }
 121   4                  }
 122   3              }
 123   2          } else {
 124   2              key_pressed = 0;
 125   2              key_press_time = 0;
 126   2              fast_mode = 0;
 127   2          }
 128   1          
 129   1          return 0;
 130   1      }
 131          
 132          void CheckAlarm() {
 133   1          u8 hour = BCD_to_Decimal(Time[2]);
 134   1          u8 min = BCD_to_Decimal(Time[1]);
 135   1          u8 sec = BCD_to_Decimal(Time[0]);
 136   1          // è§¦å‘æ¡ä»¶ï¼šé—¹é’Ÿå¼€å¯ä¸”å°æ—¶/åˆ†é’ŸåŒ¹é…ï¼Œä¸”ç§’æ•°åœ¨ 0..5 èŒƒå›´å†…
 137   1          if(alarm_enabled) {
 138   2              if(hour == Alarm_Hour && min == Alarm_Min) {
 139   3                  if(sec <= 5) {
 140   4                      if(!alarm_triggered) {
 141   5                          alarm_triggered = 1;
 142   5                          alarm_duration = 0;
 143   5                          BEEP = 0; // ä½ç”µå¹³æœ‰æ•ˆï¼Œå¼€å§‹èœ‚é¸£
 144   5                          // å¯åŠ¨éé˜»å¡èœ‚é¸£å¾ªç¯å¹¶é‡ç½®è®¡æ•°å™¨
 145   5                          alarm_beep_active = 1;
 146   5                          alarm_beep_tick = 0;
 147   5                          alarm_lcd_tick = 0;
 148   5                      }
 149   4                  }
 150   3              }
 151   2          }
 152   1          
 153   1          if(alarm_triggered) {
 154   2              alarm_duration++;
 155   2              if(alarm_duration >= 300) { // 30ç§’åè‡ªåŠ¨å…³é—­
 156   3                  alarm_triggered = 0;
 157   3                  alarm_duration = 0;
 158   3                  BEEP = 1;
 159   3                  // å…³é—­éé˜»å¡èœ‚é¸£å¹¶å…è®¸æ­£å¸¸æ˜¾ç¤ºåˆ·æ–°
 160   3                  alarm_beep_active = 0;
 161   3              }
 162   2          }
 163   1          
 164   1          // ä»»ä½•æŒ‰é”®éƒ½å¯ä»¥å…³é—­é—¹é’Ÿ
 165   1          if(alarm_triggered && (KEY_MODE == 0 || KEY_SEL == 0 || KEY_UP == 0 || KEY_DOWN == 0)) {
 166   2              alarm_triggered = 0;
 167   2              alarm_duration = 0;
 168   2              BEEP = 1;
 169   2              // ç”¨æˆ·æŒ‰é”®å…³é—­é—¹é’Ÿï¼Œåœæ­¢èœ‚é¸£å¹¶åˆ·æ–°å±å¹•
 170   2              alarm_beep_active = 0;
 171   2              LCD_WriteCmd(0x01);
 172   2              DelayMs(200); // æ¶ˆæŠ–
 173   2          }
 174   1      }
 175          
 176          // æ—¶é—´æ˜¾ç¤º
 177          // --- ã€ä¿®æ”¹åçš„æ˜¾ç¤ºæ—¶é—´å‡½æ•°ã€‘ ---
 178          void DisplayTime() {
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 4   

 179   1          u8 h24, h12;
 180   1          DS1302_ReadTime(Time); // è¯»å–æœ€æ–°æ—¶é—´
 181   1          
 182   1          // ç¬¬ä¸€è¡Œæ˜¾ç¤ºæ—¥æœŸ
 183   1          LCD_ShowString(0, 0, "20");
 184   1          LCD_ShowNum(0, 2, BCD_to_Decimal(Time[6]), 2);
 185   1          LCD_ShowString(0, 4, "-");
 186   1          LCD_ShowNum(0, 5, BCD_to_Decimal(Time[4]), 2);
 187   1          LCD_ShowString(0, 7, "-");
 188   1          LCD_ShowNum(0, 8, BCD_to_Decimal(Time[3]), 2);
 189   1          LCD_ShowString(0, 11, "W");
 190   1          LCD_ShowNum(0, 12, BCD_to_Decimal(Time[5]), 1);
 191   1          
 192   1          // æ˜¾ç¤ºæ•´ç‚¹æŠ¥æ—¶å›¾æ ‡ (å³ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ª C ä»£è¡¨ Chimeï¼Œæˆ–è€…ç©º)
 193   1          if(hourly_chime) LCD_ShowString(0, 15, "C");
 194   1          else LCD_ShowString(0, 15, " ");
 195   1      
 196   1          // ç¬¬äºŒè¡Œæ˜¾ç¤ºæ—¶é—´ (æ ¸å¿ƒé€»è¾‘)
 197   1          h24 = BCD_to_Decimal(Time[2]); // è·å–24å°æ—¶åˆ¶çš„åè¿›åˆ¶å°æ—¶
 198   1          
 199   1          if(hour_mode == 0) {
 200   2              // --- 24å°æ—¶åˆ¶æ¨¡å¼ ---
 201   2              LCD_ShowNum(1, 0, h24, 2);
 202   2              LCD_ShowString(1, 2, ":");
 203   2              LCD_ShowNum(1, 3, BCD_to_Decimal(Time[1]), 2);
 204   2              LCD_ShowString(1, 5, ":");
 205   2              LCD_ShowNum(1, 6, BCD_to_Decimal(Time[0]), 2);
 206   2              LCD_ShowString(1, 9, "       "); // æ¸…ç©ºåé¢çš„ AM/PM åŒºåŸŸ
 207   2          } else {
 208   2              // --- 12å°æ—¶åˆ¶æ¨¡å¼ ---
 209   2              // è®¡ç®— 12 å°æ—¶åˆ¶æ•°å€¼
 210   2              if(h24 == 0) h12 = 12;      // 0ç‚¹æ˜¯ 12 AM
 211   2              else if(h24 <= 12) h12 = h24; 
 212   2              else h12 = h24 - 12;        // 13-23ç‚¹ å‡12
 213   2              
 214   2              LCD_ShowNum(1, 0, h12, 2);
 215   2              LCD_ShowString(1, 2, ":");
 216   2              LCD_ShowNum(1, 3, BCD_to_Decimal(Time[1]), 2);
 217   2              LCD_ShowString(1, 5, ":");
 218   2              LCD_ShowNum(1, 6, BCD_to_Decimal(Time[0]), 2);
 219   2              
 220   2              // æ˜¾ç¤º AM æˆ– PM
 221   2              if(h24 < 12) LCD_ShowString(1, 9, " AM");
 222   2              else LCD_ShowString(1, 9, " PM");
 223   2          }
 224   1      }
 225          
 226          // é—¹é’Ÿæ˜¾ç¤ºç•Œé¢
 227          void DisplayAlarm() {
 228   1          DS1302_ReadTime(Time);
 229   1          
 230   1          LCD_ShowString(0, 0, "20");
 231   1          LCD_ShowNum(0, 2, BCD_to_Decimal(Time[6]), 2);
 232   1          LCD_ShowString(0, 4, "-");
 233   1          LCD_ShowNum(0, 5, BCD_to_Decimal(Time[4]), 2);
 234   1          LCD_ShowString(0, 7, "-");
 235   1          LCD_ShowNum(0, 8, BCD_to_Decimal(Time[3]), 2);
 236   1          LCD_ShowString(0, 13, "W");
 237   1          LCD_ShowNum(0, 14, BCD_to_Decimal(Time[5]), 1);
 238   1          
 239   1          LCD_ShowString(1, 0, "Alarm:");
 240   1          LCD_ShowNum(1, 7, Alarm_Hour, 2);
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 5   

 241   1          LCD_ShowString(1, 9, ":");
 242   1          LCD_ShowNum(1, 10, Alarm_Min, 2);
 243   1          if(alarm_triggered) {
 244   2              LCD_ShowString(1, 13, "RING");
 245   2          } else {
 246   2              if(alarm_enabled) LCD_ShowString(1, 13, "ON ");
 247   2              else LCD_ShowString(1, 13, "OFF");
 248   2          }
 249   1      }
 250          
 251          // è®¾ç½®é—¹é’Ÿç•Œé¢
 252          void DisplaySetAlarm() {
 253   1          LCD_ShowString(0, 0, "Set Alarm Time  ");
 254   1          
 255   1          if(alarm_edit_pos == 0) {
 256   2              LCD_ShowString(1, 0, ">");
 257   2              LCD_ShowNum(1, 2, Alarm_Hour, 2);
 258   2              LCD_ShowString(1, 4, ":");
 259   2              LCD_ShowNum(1, 6, Alarm_Min, 2);
 260   2              LCD_ShowString(1, 9, "Hour  ");
 261   2          } else {
 262   2              LCD_ShowString(1, 0, " ");
 263   2              LCD_ShowNum(1, 2, Alarm_Hour, 2);
 264   2              LCD_ShowString(1, 4, ":");
 265   2              LCD_ShowString(1, 6, ">");
 266   2              LCD_ShowNum(1, 7, Alarm_Min, 2);
 267   2              LCD_ShowString(1, 9, "Minute");
 268   2          }
 269   1      }
 270          
 271          // è®¾ç½®æ—¶é—´ç•Œé¢
 272          // è®¾ç½®æ—¶é—´ç•Œé¢
 273          // è®¾ç½®æ—¶é—´ç•Œé¢
 274          // è®¾ç½®æ—¶é—´ç•Œé¢
 275          void DisplaySetTime() {
 276   1          u8 hour, min, day, month, year, week;
 277   1          
 278   1          if(setting_mode) {
 279   2              hour = BCD_to_Decimal(Temp_Time[2]);
 280   2              min = BCD_to_Decimal(Temp_Time[1]);
 281   2              day = BCD_to_Decimal(Temp_Time[3]);
 282   2              month = BCD_to_Decimal(Temp_Time[4]);
 283   2              year = BCD_to_Decimal(Temp_Time[6]);  // ä½¿ç”¨ Temp_Time é‡Œçš„å¹´ä»½ (t[6]=year)
 284   2              week = BCD_to_Decimal(Temp_Time[5]); // æ˜ŸæœŸåœ¨ t[5]
 285   2          } else {
 286   2              DS1302_ReadTime(Time);
 287   2              hour = BCD_to_Decimal(Time[2]);
 288   2              min = BCD_to_Decimal(Time[1]);
 289   2              day = BCD_to_Decimal(Time[3]);
 290   2              month = BCD_to_Decimal(Time[4]);
 291   2              year = BCD_to_Decimal(Time[6]);  // ä½¿ç”¨ Time é‡Œçš„å¹´ä»½ (t[6]=year)
 292   2              week = BCD_to_Decimal(Time[5]);
 293   2          }
 294   1          
 295   1          LCD_ShowString(0, 0, "Set System Time ");
 296   1          
 297   1          switch(set_time_index) {
 298   2              case 0: // å¹´
 299   2                  LCD_ShowString(1, 0, ">Year: 20");
 300   2                  LCD_ShowNum(1, 9, year, 2);  // æ˜¾ç¤ºä¿®æ”¹åçš„å¹´ä»½
 301   2                  LCD_ShowString(1, 11, "     ");
 302   2                  break;
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 6   

 303   2              case 1: // æœˆ
 304   2                  LCD_ShowString(1, 0, ">Month:  ");
 305   2                  LCD_ShowNum(1, 8, month, 2);
 306   2                  LCD_ShowString(1, 10, "     ");
 307   2                  break;
 308   2              case 2: // æ—¥
 309   2                  LCD_ShowString(1, 0, ">Day:    ");
 310   2                  LCD_ShowNum(1, 8, day, 2);
 311   2                  LCD_ShowString(1, 10, "     ");
 312   2                  break;
 313   2              case 3: // æ—¶
 314   2                  LCD_ShowString(1, 0, ">Hour:   ");
 315   2                  LCD_ShowNum(1, 8, hour, 2);
 316   2                  LCD_ShowString(1, 10, "     ");
 317   2                  break;
 318   2              case 4: // åˆ†
 319   2                  LCD_ShowString(1, 0, ">Minute: ");
 320   2                  LCD_ShowNum(1, 8, min, 2);
 321   2                  LCD_ShowString(1, 10, "     ");
 322   2                  break;
 323   2              case 5: // æ˜ŸæœŸ
 324   2                  LCD_ShowString(1, 0, ">Week:   ");
 325   2                  LCD_ShowNum(1, 8, week, 1);
 326   2                  LCD_ShowString(1, 9, "      ");
 327   2                  break;
 328   2          }
 329   1      }
 330          
 331          // ä¸»å¾ªç¯
 332          void main() {
 333   1          u8 key;
 334   1          u8 i;
 335   1      
 336   1          LCD_Init();
 337   1          DS1302_Init();
 338   1          BEEP = 1;
 339   1      // 1. å°è¯•è¯»å–â€œæš—å·â€å’Œé—¹é’Ÿæ•°æ®
 340   1          if(DS1302_ReadRam(RAM_CHECK_ADDR) == 0xAA) {
 341   2              // è¯´æ˜ç”µæ± ä¸€ç›´æœ‰ç”µï¼Œç›´æ¥æŠŠå­˜å¥½çš„é—¹é’Ÿæ‹¿å‡ºæ¥ç”¨
 342   2              Alarm_Hour    = DS1302_ReadRam(RAM_ALARM_H);
 343   2              Alarm_Min     = DS1302_ReadRam(RAM_ALARM_M);
 344   2              alarm_enabled = DS1302_ReadRam(RAM_ALARM_EN);
 345   2          } else {
 346   2              // è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ç”¨ï¼ˆæ¯”å¦‚åˆšä¹°çš„ç”µæ± ï¼‰ï¼Œå…ˆå†™ä¸€ä»½é»˜è®¤å€¼è¿›å»
 347   2              DS1302_WriteRam(RAM_CHECK_ADDR, 0xAA);  // ç§ä¸‹æš—å·
 348   2              DS1302_WriteRam(RAM_ALARM_H, Alarm_Hour);
 349   2              DS1302_WriteRam(RAM_ALARM_M, Alarm_Min);
 350   2              DS1302_WriteRam(RAM_ALARM_EN, alarm_enabled);
 351   2          }
 352   1      
 353   1          // 2. æ£€æŸ¥ RTC æ—¶é—´æ˜¯å¦ä¹±ç ï¼ˆæ— ç”µæ± ä¸Šç”µé€šå¸¸è¿”å›å…¨0æˆ–åƒåœ¾å€¼æ•°æ®ï¼‰
 354   1          DS1302_ReadTime(Time);
 355   1          if(!IsTimeValid(Time)) {
 356   2              // æ—¶é—´ä¸å¯¹ï¼Œæç¤ºç”¨æˆ·é‡æ–°è®¾è¡¨
 357   2              rtc_invalid_start = 1;
 358   2              LCD_ShowString(0, 0, " RTC Invalid!   ");
 359   2              LCD_ShowString(1, 0, " Please Set Time ");
 360   2              DelayMs(1500);
 361   2              LCD_WriteCmd(0x01);
 362   2      
 363   2              // è‡ªåŠ¨è·³è½¬åˆ°è®¾ç½®æ—¶é—´æ¨¡å¼ (Mode 3)
 364   2              mode = 3;
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 7   

 365   2              setting_mode = 1;
 366   2              set_time_index = 0;
 367   2              
 368   2              // ç»™å‡ºä¸€ç»„é»˜è®¤æ—¶é—´ä¾›ä¿®æ”¹
 369   2              Temp_Time[0] = Decimal_to_BCD(0); // ç§’
 370   2              Temp_Time[1] = Decimal_to_BCD(0); // åˆ†
 371   2              Temp_Time[2] = Decimal_to_BCD(12);// æ—¶ï¼ˆé»˜è®¤ä¸­åˆ12ç‚¹ï¼‰
 372   2              Temp_Time[3] = Decimal_to_BCD(1); // æ—¥
 373   2              Temp_Time[4] = Decimal_to_BCD(1); // æœˆ
 374   2              Temp_Time[5] = Decimal_to_BCD(1); // å‘¨
 375   2              Temp_Time[6] = Decimal_to_BCD(25);// å¹´ (2025å¹´)
 376   2          } else {
 377   2              // æ—¶é—´æ­£å¸¸ï¼Œæ­£å¸¸å¼€æœº
 378   2              LCD_ShowString(0, 0, "  Smart Clock   ");
 379   2              LCD_ShowString(1, 0, "  Starting...   ");
 380   2              DelayMs(1000);
 381   2              LCD_WriteCmd(0x01);
 382   2          }
 383   1      
 384   1          if(DS1302_ReadRam(RAM_CHECK_ADDR) == 0xAA) {
 385   2              hour_mode = DS1302_ReadRam(RAM_HOUR_MODE);
 386   2              hourly_chime = DS1302_ReadRam(RAM_HOURLY_EN);
 387   2          } else {
 388   2              // å¦‚æœæ˜¯æ–°ç”µæ± ï¼Œåˆå§‹åŒ–ä¸ºé»˜è®¤å€¼å¹¶ä¿å­˜
 389   2              DS1302_WriteRam(RAM_HOUR_MODE, 0);   // é»˜è®¤ 24å°æ—¶åˆ¶
 390   2              DS1302_WriteRam(RAM_HOURLY_EN, 0);   // é»˜è®¤ å…³é—­æ•´ç‚¹æŠ¥æ—¶
 391   2          }
 392   1          
 393   1          while(1) {
 394   2              // å¦‚æœä¸æ˜¯è®¾ç½®æ—¶é—´æ¨¡å¼ï¼Œåˆ™å§‹ç»ˆè¯»å–æœ€æ–°æ—¶é—´
 395   2              if(!(mode == 3 && setting_mode)) {
 396   3                  DS1302_ReadTime(Time);  // ç¡®ä¿åœ¨éè®¾ç½®æ¨¡å¼ä¸‹è¯»å–æœ€æ–°æ—¶é—´
 397   3              }
 398   2      
 399   2              key = KeyScan();
 400   2      
 401   2              // å¤„ç†æ¨¡å¼åˆ‡æ¢ (K1é”®)
 402   2              if(key == 1 && !setting_mode) {
 403   3                  mode++;
 404   3                  if(mode > 3) mode = 0;
 405   3                  LCD_WriteCmd(0x01); // æ¸…é™¤å±å¹•
 406   3              }
 407   2      
 408   2      switch(mode) {
 409   3                  case 0:  // æ˜¾ç¤ºæ—¶é—´æ¨¡å¼
 410   3                      if(!suppress_lcd) DisplayTime();
 411   3                      
 412   3                      // --- ã€æ–°å¢ï¼šæ¨¡å¼ 0 ä¸‹çš„å¿«æ·é”®ã€‘ ---
 413   3                      // æŒ‰ K3 (UP) åˆ‡æ¢ 12/24 å°æ—¶åˆ¶
 414   3                      if(key == 3) {
 415   4                          hour_mode = !hour_mode; // åˆ‡æ¢çŠ¶æ€
 416   4                          DS1302_WriteRam(RAM_HOUR_MODE, hour_mode); // ç«‹å³ä¿å­˜
 417   4                          LCD_WriteCmd(0x01); // æ¸…å±åˆ·æ–°
 418   4                      }
 419   3                      
 420   3                      // æŒ‰ K4 (DOWN) åˆ‡æ¢æ•´ç‚¹æŠ¥æ—¶
 421   3                      if(key == 4) {
 422   4                          hourly_chime = !hourly_chime; // åˆ‡æ¢çŠ¶æ€
 423   4                          DS1302_WriteRam(RAM_HOURLY_EN, hourly_chime); // ç«‹å³ä¿å­˜
 424   4                          // èœ‚é¸£å™¨å«ä¸€å£°æç¤ºçŠ¶æ€å˜åŒ–
 425   4                          BEEP = 0; DelayMs(100); BEEP = 1; 
 426   4                      }
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 8   

 427   3                      // -----------------------------------
 428   3                      break;
 429   3                      
 430   3                  case 1:  // æ˜¾ç¤ºé—¹é’Ÿæ¨¡å¼
 431   3                      if(!suppress_lcd) DisplayAlarm();
 432   3                      // æ–¹ä¾¿è°ƒè¯•ï¼šåœ¨é—¹é’Ÿæ˜¾ç¤ºç•Œé¢æŒ‰ KEY_UP (K3) å¯ä»¥æ‰‹åŠ¨åˆ‡æ¢é—¹é’Ÿå“é“ƒçŠ¶æ€
             -
 433   3                      if(!setting_mode && key == 3) {
 434   4                          if(!alarm_triggered) {
 435   5                              // å¯åŠ¨é—¹é’Ÿï¼ˆä¸è‡ªåŠ¨è§¦å‘ä¸€è‡´çš„éé˜»å¡è¡Œä¸ºï¼‰
 436   5                              alarm_triggered = 1;
 437   5                              alarm_duration = 0;
 438   5                              BEEP = 0; // å¯åŠ¨èœ‚é¸£å™¨ï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰
 439   5                              alarm_beep_active = 1;
 440   5                              alarm_beep_tick = 0;
 441   5                              alarm_lcd_tick = 0;
 442   5                              // ç­‰å¾…æŒ‰é”®é‡Šæ”¾ï¼Œé¿å…åŒæ¬¡æŒ‰é”®è¢«æ£€æµ‹ä¸ºå…³é—­é—¹é’Ÿ
 443   5                              while(KEY_UP == 0) DelayMs(10);
 444   5                          } else {
 445   5                              // å¦‚æœå·²ç»åœ¨å“é“ƒï¼ŒæŒ‰ä¸€æ¬¡åœæ­¢ï¼ˆä¸å…¶ä»–æŒ‰é”®è¡Œä¸ºä¸€è‡´ï¼‰
 446   5                              alarm_triggered = 0;
 447   5                              alarm_duration = 0;
 448   5                              BEEP = 1;
 449   5                              alarm_beep_active = 0;
 450   5                              LCD_WriteCmd(0x01);
 451   5                              DelayMs(200);
 452   5                          }
 453   4                      }
 454   3                      // åœ¨é—¹é’Ÿæ˜¾ç¤ºç•Œé¢æŒ‰ KEY_SEL (K2) åˆ‡æ¢é—¹é’Ÿå¼€å…³å¹¶æŒä¹…ä¿å­˜
 455   3                      if(!setting_mode && key == 2) {
 456   4                          alarm_enabled = !alarm_enabled;
 457   4                          // æŒä¹…åŒ–åˆ° DS1302 çš„ RAM 0
 458   4                          DS1302_WriteRam(0, alarm_enabled ? 0x01 : 0x00);
 459   4                          if(alarm_enabled) {
 460   5                              LCD_ShowString(0, 0, " Alarm: ON     ");
 461   5                          } else {
 462   5                              LCD_ShowString(0, 0, " Alarm: OFF    ");
 463   5                          }
 464   4                          DelayMs(800);
 465   4                          LCD_WriteCmd(0x01);
 466   4                      }
 467   3                      break;
 468   3                      
 469   3                  case 2:  // è®¾ç½®é—¹é’Ÿæ¨¡å¼
 470   3                      if(!setting_mode) {
 471   4                          DisplaySetAlarm();
 472   4                          if(key == 1) {
 473   5                            
 474   5                              setting_mode = 1;
 475   5                              alarm_edit_pos = 0;
 476   5                              LCD_WriteCmd(0x01);
 477   5                          }
 478   4                      } else {
 479   4                          DisplaySetAlarm();
 480   4                          
 481   4                          if(key == 2) {
 482   5                              alarm_edit_pos = !alarm_edit_pos;
 483   5                              DelayMs(200);
 484   5                          }
 485   4                          
 486   4                          if(key == 3) {
 487   5                              if(alarm_edit_pos == 0) {
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 9   

 488   6                                  Alarm_Hour++;
 489   6                                  if(Alarm_Hour >= 24) Alarm_Hour = 0;
 490   6                              } else {
 491   6                                  Alarm_Min++;
 492   6                                  if(Alarm_Min >= 60) Alarm_Min = 0;
 493   6                              }
 494   5                              if(!fast_mode) DelayMs(200);
 495   5                          }
 496   4                          
 497   4                          if(key == 4) {
 498   5                              if(alarm_edit_pos == 0) {
 499   6                                  if(Alarm_Hour == 0) Alarm_Hour = 23;
 500   6                                  else Alarm_Hour--;
 501   6                              } else {
 502   6                                  if(Alarm_Min == 0) Alarm_Min = 59;
 503   6                                  else Alarm_Min--;
 504   6                              }
 505   5                              if(!fast_mode) DelayMs(200);
 506   5                          }
 507   4                          
 508   4                          if(key == 1) {
 509   5                            DS1302_WriteRam(1, Alarm_Hour);
 510   5                  DS1302_WriteRam(2, Alarm_Min);
 511   5                  DS1302_WriteRam(3, alarm_enabled);
 512   5                              setting_mode = 0;
 513   5                              LCD_ShowString(0, 0, " Alarm Saved!   ");
 514   5                              LCD_ShowString(1, 0, "                ");
 515   5                              DelayMs(1000);
 516   5                              LCD_WriteCmd(0x01);
 517   5                          }
 518   4                      }
 519   3                      break;
 520   3                      
 521   3                  case 3:  // è®¾ç½®ç³»ç»Ÿæ—¶é—´æ¨¡å¼
 522   3                      if(!setting_mode) {
 523   4                          DisplaySetTime();
 524   4                          if(key == 1) {
 525   5                              setting_mode = 1;
 526   5                              set_time_index = 0;
 527   5                              // ä¿å­˜å½“å‰æ—¶é—´åˆ° Temp_Time æ•°ç»„
 528   5                              for(i = 0; i < 7; i++) {
 529   6                                  Temp_Time[i] = Time[i];
 530   6                              }
 531   5                              LCD_WriteCmd(0x01);
 532   5                          }
 533   4                      } else {
 534   4                          DisplaySetTime();
 535   4                          
 536   4                          if(key == 2) {
 537   5                              set_time_index++;
 538   5                              if(set_time_index > 5) set_time_index = 0;
 539   5                              DelayMs(200);
 540   5                          }
 541   4                          
 542   4                          if(key == 3) {
 543   5                              switch(set_time_index) {
 544   6                                  case 0: // å¹´
 545   6                                          {
 546   7                                              u8 v = BCD_to_Decimal(Temp_Time[6]);
 547   7                                              v++;
 548   7                                              if(v > 99) v = 0;
 549   7                                              Temp_Time[6] = Decimal_to_BCD(v);
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 10  

 550   7                                          }
 551   6                                      break;
 552   6                                  case 1: // æœˆ
 553   6                                          {
 554   7                                              u8 v = BCD_to_Decimal(Temp_Time[4]);
 555   7                                              v++;
 556   7                                              if(v > 12) v = 1;
 557   7                                              Temp_Time[4] = Decimal_to_BCD(v);
 558   7                                          }
 559   6                                      break;
 560   6                                  case 2: // æ—¥
 561   6                                          {
 562   7                                              u8 v = BCD_to_Decimal(Temp_Time[3]);
 563   7                                              v++;
 564   7                                              if(v > 31) v = 1;
 565   7                                              Temp_Time[3] = Decimal_to_BCD(v);
 566   7                                          }
 567   6                                      break;
 568   6                                  case 3: // æ—¶
 569   6                                          {
 570   7                                              u8 v = BCD_to_Decimal(Temp_Time[2]);
 571   7                                              v++;
 572   7                                              if(v >= 24) v = 0;
 573   7                                              Temp_Time[2] = Decimal_to_BCD(v);
 574   7                                          }
 575   6                                      break;
 576   6                                  case 4: // åˆ†
 577   6                                          {
 578   7                                              u8 v = BCD_to_Decimal(Temp_Time[1]);
 579   7                                              v++;
 580   7                                              if(v >= 60) v = 0;
 581   7                                              Temp_Time[1] = Decimal_to_BCD(v);
 582   7                                          }
 583   6                                      break;
 584   6                                  case 5: // æ˜ŸæœŸ
 585   6                                          {
 586   7                                              u8 v = BCD_to_Decimal(Temp_Time[5]);
 587   7                                              v++;
 588   7                                              if(v > 7) v = 1;
 589   7                                              Temp_Time[5] = Decimal_to_BCD(v);
 590   7                                          }
 591   6                                      break;
 592   6                              }
 593   5                              if(!fast_mode) DelayMs(200);
 594   5                          }
 595   4                          
 596   4                          if(key == 4) {
 597   5                              switch(set_time_index) {
 598   6                                  case 0: // å¹´
 599   6                                          {
 600   7                                              u8 v = BCD_to_Decimal(Temp_Time[6]);
 601   7                                              if(v == 0) v = 99;
 602   7                                              else v--;
 603   7                                              Temp_Time[6] = Decimal_to_BCD(v);
 604   7                                          }
 605   6                                      break;
 606   6                                  case 1: // æœˆ
 607   6                                          {
 608   7                                              u8 v = BCD_to_Decimal(Temp_Time[4]);
 609   7                                              if(v == 1) v = 12;
 610   7                                              else v--;
 611   7                                              Temp_Time[4] = Decimal_to_BCD(v);
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 11  

 612   7                                          }
 613   6                                      break;
 614   6                                  case 2: // æ—¥
 615   6                                          {
 616   7                                              u8 v = BCD_to_Decimal(Temp_Time[3]);
 617   7                                              if(v == 1) v = 31;
 618   7                                              else v--;
 619   7                                              Temp_Time[3] = Decimal_to_BCD(v);
 620   7                                          }
 621   6                                      break;
 622   6                                  case 3: // æ—¶
 623   6                                          {
 624   7                                              u8 v = BCD_to_Decimal(Temp_Time[2]);
 625   7                                              if(v == 0) v = 23;
 626   7                                              else v--;
 627   7                                              Temp_Time[2] = Decimal_to_BCD(v);
 628   7                                          }
 629   6                                      break;
 630   6                                  case 4: // åˆ†
 631   6                                          {
 632   7                                              u8 v = BCD_to_Decimal(Temp_Time[1]);
 633   7                                              if(v == 0) v = 59;
 634   7                                              else v--;
 635   7                                              Temp_Time[1] = Decimal_to_BCD(v);
 636   7                                          }
 637   6                                      break;
 638   6                                  case 5: // æ˜ŸæœŸ
 639   6                                          {
 640   7                                              u8 v = BCD_to_Decimal(Temp_Time[5]);
 641   7                                              if(v == 1) v = 7;
 642   7                                              else v--;
 643   7                                              Temp_Time[5] = Decimal_to_BCD(v);
 644   7                                          }
 645   6                                      break;
 646   6                              }
 647   5                              if(!fast_mode) DelayMs(200);
 648   5                          }
 649   4                          
 650   4                          if(key == 1) {
 651   5                              setting_mode = 0;
 652   5                              set_time_index = 0;
 653   5                              // åœ¨å†™å…¥ RTC å‰æ ¡éªŒåè¿›åˆ¶èŒƒå›´ï¼Œé˜²æ­¢æœªåˆå§‹åŒ–æˆ–éæ³•æ•°æ®å†™å…
             -¥
 654   5                              {
 655   6                                  u8 sec = BCD_to_Decimal(Temp_Time[0]);
 656   6                                  u8 min = BCD_to_Decimal(Temp_Time[1]);
 657   6                                  u8 hour = BCD_to_Decimal(Temp_Time[2]);
 658   6                                  u8 day = BCD_to_Decimal(Temp_Time[3]);
 659   6                                  u8 month = BCD_to_Decimal(Temp_Time[4]);
 660   6                                  u8 week = BCD_to_Decimal(Temp_Time[5]);
 661   6                                  u8 year = BCD_to_Decimal(Temp_Time[6]);
 662   6      
 663   6                                  if(sec > 59 || min > 59 || hour > 23 || day < 1 || day > 31 || month < 1 || mo
             -nth > 12 || week < 1 || week > 7 || year > 99) {
 664   7                                      LCD_ShowString(0, 0, " Invalid Time!  ");
 665   7                                      LCD_ShowString(1, 0, " Save Aborted   ");
 666   7                                      DelayMs(1000);
 667   7                                      LCD_WriteCmd(0x01);
 668   7                                      // ä¸å†™å…¥ RTCï¼Œæ¢å¤æ˜¾ç¤º
 669   7                                      // æ›´æ–° Time æ•°ç»„ä»¥ä¿è¯ç•Œé¢åŒæ­¥
 670   7                                      for(i = 0; i < 7; i++) {
 671   8                                          Time[i] = Temp_Time[i];
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 12  

 672   8                                      }
 673   7                                      break;
 674   7                                  }
 675   6                              }
 676   5                              // ä¿å­˜æ—¶é—´åˆ° DS1302ï¼ˆé€šè¿‡æ ¡éªŒåå†™å…¥ï¼‰
 677   5                              // å°†ç§’å½’é›¶ä»¥é¿å…æœªè®¾ç½®çš„ç§’å¯¼è‡´å†™å…¥åæ˜¾ç¤ºå¼‚å¸¸
 678   5                              Temp_Time[0] = Decimal_to_BCD(0);
 679   5                              DS1302_SetTime(Temp_Time); // å†™å…¥ RTC
 680   5                              // ç»™ RTC å°‘è®¸æ—¶é—´ç¨³å®šï¼Œç„¶åè¯»å›ç¡®è®¤å¹¶åˆ·æ–°æ˜¾ç¤ºæ•°æ®
 681   5                              DelayMs(200);
 682   5                              DS1302_ReadTime(Time);
 683   5                              // å¦‚æœè¯»å›å€¼ä»ç„¶éæ³•ï¼Œåˆ™é€€å›ä½¿ç”¨åˆšä¿å­˜çš„ Temp_Time
 684   5                              if(!IsTimeValid(Time)) {
 685   6                                  for(i = 0; i < 7; i++) {
 686   7                                      Time[i] = Temp_Time[i];
 687   7                                  }
 688   6                              }
 689   5                              // ä¿å­˜å®Œæˆåç«‹å³åˆ‡æ¢åˆ°æ—¶é—´æ˜¾ç¤ºé¡µé¢å¹¶æ¢å¤æ­£å¸¸è¿è¡Œ
 690   5                              mode = 0;              // åˆ‡æ¢åˆ°æ˜¾ç¤ºæ—¶é—´æ¨¡å¼
 691   5                              rtc_invalid_start = 0; // æ¸…é™¤æ— æ•ˆ RTC æ ‡å¿—ï¼ˆå¦‚æœ‰ï¼‰
 692   5                              LCD_ShowString(0, 0, " Time Saved!    ");
 693   5                              LCD_ShowString(1, 0, "                ");
 694   5                              DelayMs(1000);
 695   5                              LCD_WriteCmd(0x01);
 696   5                          }
 697   4                      }
 698   3                      break;
 699   3              }
 700   2      
 701   2              CheckAlarm();
 702   2              {
 703   3                  static u8 last_hour_beep = 99; // è®°å½•ä¸Šæ¬¡å“é“ƒæ—¶çš„ç§’æ•°
 704   3                  u8 current_sec = BCD_to_Decimal(Time[0]);
 705   3                  u8 current_min = BCD_to_Decimal(Time[1]);
 706   3      
 707   3                  if(hourly_chime && current_min == 0 && current_sec == 0) {
 708   4                      if(last_hour_beep != current_sec) {
 709   5                          // è§¦å‘æŠ¥æ—¶ï¼šå˜€-å˜€ ä¸¤å£°
 710   5                          BEEP = 0; DelayMs(100); BEEP = 1; DelayMs(100);
 711   5                          BEEP = 0; DelayMs(100); BEEP = 1;
 712   5                          last_hour_beep = current_sec; // æ ‡è®°è¿™ä¸€ç§’å·²ç»å“è¿‡äº†
 713   5                      }
 714   4                  } else {
 715   4                       if(current_sec != 0) last_hour_beep = 99; // é‡ç½®æ ‡è®°
 716   4                  }
 717   3              }
 718   2      
 719   2              // éé˜»å¡èœ‚é¸£æ§åˆ¶ï¼šå¦‚æœå¤„äºé—¹é’Ÿå“é“ƒçŠ¶æ€ï¼Œä»¥å›ºå®šèŠ‚æ‹åˆ‡æ¢ BEEP
 720   2              if(alarm_beep_active) {
 721   3                  alarm_beep_tick++;
 722   3                  if(alarm_beep_tick >= 2) { // 2 * 50ms = ~100ms åˆ‡æ¢ä¸€æ¬¡
 723   4                      alarm_beep_tick = 0;
 724   4                      BEEP = !BEEP;
 725   4                  }
 726   3                  // å‘¨æœŸæ€§åˆ·æ–°å±å¹•ï¼ˆæ¯ ~500msï¼‰ä»¥ä¿æŒæ˜¾ç¤ºæ›´æ–°
 727   3                  alarm_lcd_tick++;
 728   3                  if(alarm_lcd_tick >= 10) {
 729   4                      alarm_lcd_tick = 0;
 730   4                      // å¦‚æœå½“å‰åœ¨é—¹é’Ÿæ˜¾ç¤ºç•Œé¢ï¼Œåˆ·æ–°é—¹é’Ÿç•Œé¢ï¼›å¦åˆ™åˆ·æ–°æ—¶é—´ç•Œé¢
 731   4                      if(mode == 1) DisplayAlarm();
 732   4                      else DisplayTime();
 733   4                  }
C51 COMPILER V9.60.7.0   MAIN                                                              12/28/2025 08:47:58 PAGE 13  

 734   3              }
 735   2      
 736   2              DelayMs(50);
 737   2          }
 738   1      }
 739          
 740          
 741          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3289    ----
   CONSTANT SIZE    =    358    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     34      27
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
